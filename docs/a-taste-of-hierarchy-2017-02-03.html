<!DOCTYPE html>
<html lang="en">
<head>
		<title>SKiDL &mdash; A Taste of Hierarchy</title>
		<meta charset="utf-8" />
		<link rel="profile" href="http://gmpg.org/xfn/11" />
		<link rel="stylesheet" type="text/css" href="/skidl/theme/css/style.css" />
		<link rel='stylesheet' id='oswald-css'  href='http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2' type='text/css' media='all' />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Oswald&family=Roboto+Condensed&display=swap" rel="stylesheet">
		<!-- <style type="text/css">
			body.custom-background { background-color: #f5f5f5; }
		</style> -->
		<link rel="alternate" type="application/atom+xml"
			title="SKiDL â€” Flux Atom"
			href="/skidl/" />
		<!--[if lte IE 8]><script src="/skidl/theme/js/html5shiv.js"></script><![endif]-->
</head>

<body class="home blog custom-background " >
	<div id="container">
		<div id="header">
				<h1 id="site-title"><a href="/skidl"><img src="/skidl/images/banner.png" width="100%"></a></h1>
				<!-- <h1 id="site-title"><a href="/skidl">SKiDL</a></h1> -->
		</div><!-- /#banner -->

		<div id="menu">
			<div class="menu-navigation-container">
				<ul id="menu-navigation" class="menu">
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://github.com/devbisme/skidl">Github</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="https://github.com/devbisme/skidl/discussions">Forum</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/skidl/category/posts.html">Blog</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/skidl/api/html/index.html">API</a></li>
						<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/skidl/">Home</a></li>

				</ul>
			</div> <!--/#menu-navigation-container-->
		</div><!-- /#menu -->

		<div class="page-title">
		</div>

		<div id="contents">

<div class="post type-post status-publish format-standard hentry category-general" id="post">
	<div class="entry-meta">
		<span class="date"><a href="/skidl/a-taste-of-hierarchy-2017-02-03.html">Fri 03 February 2017</a></span>
		/
		<span class="byline"><a href="/skidl/author/dave-vandenbout.html">Dave Vandenbout</a></span>
	</div> <!-- /#entry-meta -->
	<div class="main">
		<h2 class="entry-title">
			<a href="/skidl/a-taste-of-hierarchy-2017-02-03.html" title="Permalink to A Taste of Hierarchy" rel="bookmark">A Taste of Hierarchy</a>
		</h2>
		<div class="entry-content">
			<p>In my previous blog posts, the SKiDL circuit descriptions were <em>flat</em>.
In this post, I'll show a bit of how to describe a circuit <em>hierarchically</em>.</p>
<p>Hierarchy is typically used when there is some subcircuit that needs to be
replicated several times or which can serve as a module in several different designs.
In the USB-to-JTAG interface board, the crystal with its two trimming capacitors
is a good candidate for encapsulation in a subcircuit because this combination
of components appears in many circuits.
Here's what a SKiDL subcircuit for the crystal circuit looks like:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SubCircuit</span>
<span class="k">def</span> <span class="nf">osc</span><span class="p">(</span><span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Attach a crystal and two caps to the osc1 and osc2 nets.&#39;&#39;&#39;</span>
    <span class="n">xtal</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="n">xess_lib</span><span class="p">,</span> <span class="s1">&#39;XTAL4&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="s1">&#39;XESS:32x25-4&#39;</span><span class="p">)</span> <span class="c1"># Instantiate the crystal from the library.</span>
    <span class="n">xtal</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gnd</span>                   <span class="c1"># Connect the crystal ground pins.</span>
    <span class="n">xtal</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>            <span class="c1"># Connect the crystal pins to the oscillator nets.</span>
    <span class="n">trim_cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;10pf&#39;</span><span class="p">)</span>     <span class="c1"># Instantiate a pair of trimmer caps.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">gnd</span>      <span class="c1"># Connect the trimmer caps to the crystal.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span>
</code></pre></div>

<p>The <code>@SubCircuit</code> decorator handles some housekeeping that's necessary to
integrate the encapsulated circuit into the larger whole.
That's followed by a Python function containing SKiDL code for the subcircuit.
(Look back at <a href="{{ SITE_URL }}/blog/building-a-usb-to-jtag-interface-using-skidl">this post</a>
for a description of what this code does.)</p>
<p>Once the subcircuit is defined, all you need to do is call it somewhere within the
main SKiDL code:</p>
<div class="highlight"><pre><span></span><code><span class="n">osc</span><span class="p">(</span> <span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC1&#39;</span><span class="p">],</span> <span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC2&#39;</span><span class="p">],</span> <span class="n">gnd</span> <span class="p">)</span>
</code></pre></div>

<p>The function call will pass the oscillator pins of the PIC32 microcontroller to the
subcircuit so they can be attached to the crystal and capacitors (along with the
ground net, <code>gnd</code>).</p>
<p>Now, there are several problems that make this subcircuit less than ideal:</p>
<ol>
<li>It depends upon the <code>xess_lib</code> global variable to find the library with the crystal.</li>
<li>It uses a fixed crystal type from that library: <code>XTAL4</code>.</li>
<li>It references the global <code>cap</code> template to instantiate the trimming capacitors.</li>
</ol>
<p>In order to make the subcircuit more general, we can pass the crystal and capacitor
parts as parameters to the function:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SubCircuit</span>
<span class="k">def</span> <span class="nf">osc</span><span class="p">(</span><span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span><span class="p">,</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">cap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Attach a crystal and two caps to the osc1 and osc2 nets.&#39;&#39;&#39;</span>
    <span class="n">xtal</span> <span class="o">=</span> <span class="n">crystal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                  <span class="c1"># Instantiate the crystal from the template.</span>
    <span class="n">xtal</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gnd</span>                  <span class="c1"># Connect the crystal ground pins.</span>
    <span class="n">xtal</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>           <span class="c1"># Connect the crystal pins to the oscillator nets.</span>
    <span class="n">trim_cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;10pf&#39;</span><span class="p">)</span>    <span class="c1"># Instantiate a pair of trimmer caps.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">gnd</span>     <span class="c1"># Connect the trimmer caps to the crystal.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span>
</code></pre></div>

<p>But that means you have to create the template for the crystal before calling the
<code>osc</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="n">crystal</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="n">xess_lib</span><span class="p">,</span> <span class="s1">&#39;XTAL4&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="s1">&#39;XESS:32x25-4&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">)</span>
<span class="n">osc</span><span class="p">(</span><span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC1&#39;</span><span class="p">],</span> <span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC2&#39;</span><span class="p">],</span> <span class="n">gnd</span><span class="p">,</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>
</code></pre></div>

<p>This works fine as long as you're using a crystal in a four-pin package.
But many crystals only have two terminals.
You can handle that in the subcircuit function as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SubCircuit</span>
<span class="k">def</span> <span class="nf">osc</span><span class="p">(</span><span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span><span class="p">,</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">cap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Attach a crystal and two caps to the osc1 and osc2 nets.&#39;&#39;&#39;</span>
    <span class="n">xtal</span> <span class="o">=</span> <span class="n">crystal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                  <span class="c1"># Instantiate the crystal from the template.</span>
    <span class="n">num_xtal_pins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xtal</span><span class="p">[</span><span class="s1">&#39;.*&#39;</span><span class="p">])</span>    <span class="c1"># Get the number of pins on the crystal.</span>
    <span class="k">if</span> <span class="n">num_xtal_pins</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>             <span class="c1"># This handles a 4-pin crystal...</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gnd</span>              <span class="c1"># Connect the crystal ground pins.</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>       <span class="c1"># Connect the crystal pins to the oscillator nets.</span>
    <span class="k">else</span><span class="p">:</span>                              <span class="c1"># Otherwise assume it&#39;s a 2-pin crystal...</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>        <span class="c1"># Using a two-pin crystal.</span>
    <span class="n">trim_cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;10pf&#39;</span><span class="p">)</span>    <span class="c1"># Instantiate a pair of trimmer caps.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">gnd</span>     <span class="c1"># Connect the trimmer caps to the crystal.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span>
</code></pre></div>

<p>The wildcard regular expression makes <code>xtal['.*']</code> return a list of all of its pins.
Then, the Python <code>len</code> operator gets the length of the list and tells us how many pins the crystal has.
After that, it's just a matter of connecting the right pins depending upon how many there are.
Now if you call the <code>osc</code> function with a two-pin crystal, it will work correctly:</p>
<div class="highlight"><pre><span></span><code><span class="n">crystal</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">,</span> <span class="s1">&#39;Crystal&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="s1">&#39;Crystal:Crystal_HC49-U_Vertical&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">)</span>
<span class="n">osc</span><span class="p">(</span><span class="o">*</span><span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC1, OSC2&#39;</span><span class="p">],</span> <span class="n">gnd</span><span class="p">,</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>
</code></pre></div>

<p>Of course, sometimes you might want a simpler way to instantiate the subcircuit
without having to pass components as parameters.
Python default parameters come to the rescue!</p>
<div class="highlight"><pre><span></span><code><span class="nd">@SubCircuit</span>
<span class="k">def</span> <span class="nf">osc</span><span class="p">(</span><span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span><span class="p">,</span> 
        <span class="n">crystal</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">,</span> <span class="s1">&#39;Crystal&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="s1">&#39;Crystal:Crystal_HC49-U_Vertical&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">),</span> 
        <span class="n">cap</span> <span class="o">=</span> <span class="n">Part</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;10pf&#39;</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="s1">&#39;Capacitors_SMD:C_0603&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">)</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Attach a crystal and two caps to the osc1 and osc2 nets.&#39;&#39;&#39;</span>
    <span class="n">xtal</span> <span class="o">=</span> <span class="n">crystal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                  <span class="c1"># Instantiate the crystal from the template.</span>
    <span class="n">num_xtal_pins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xtal</span><span class="p">[</span><span class="s1">&#39;.*&#39;</span><span class="p">])</span>    <span class="c1"># Get the number of pins on the crystal.</span>
    <span class="k">if</span> <span class="n">num_xtal_pins</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>             <span class="c1"># This handles a 4-pin crystal...</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gnd</span>              <span class="c1"># Connect the crystal ground pins.</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>       <span class="c1"># Connect the crystal pins to the oscillator nets.</span>
    <span class="k">else</span><span class="p">:</span>                              <span class="c1"># Otherwise assume it&#39;s a 2-pin crystal...</span>
        <span class="n">xtal</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">osc2</span>        <span class="c1"># Using a two-pin crystal.</span>
    <span class="n">trim_cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                  <span class="c1"># Instantiate some trimmer caps.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc1</span><span class="p">,</span> <span class="n">gnd</span>     <span class="c1"># Connect the trimmer caps to the crystal.</span>
    <span class="n">trim_cap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">osc2</span><span class="p">,</span> <span class="n">gnd</span>
</code></pre></div>

<p>Now you can instantiate the default oscillator circuit with the function call:</p>
<div class="highlight"><pre><span></span><code><span class="n">osc</span><span class="p">(</span><span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC1&#39;</span><span class="p">],</span> <span class="n">pic32</span><span class="p">[</span><span class="s1">&#39;OSC2&#39;</span><span class="p">],</span> <span class="n">gnd</span><span class="p">)</span>
</code></pre></div>

<p>Finally, here's the <a href="{{ SITE_URL }}/files/a-taste-of-hierarchy/intfc_brd.py">complete SKiDL program</a> so you can see how it fits together:</p>
<div class="highlight"><pre><span></span><code>{% include &#39;/files/a-taste-of-hierarchy/intfc_brd.py&#39; %}
</code></pre></div>
		</div> <!--/#entry-content-->
	</div> <!--/#main-->
</div>  <!--/#post-->

		</div>

		<div id="footer">
			<p> </p>
		</div><!-- /#footer -->
	</div><!-- /#container -->
	<div style="display:none"></div>
</body>
</html>