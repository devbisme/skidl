

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>skidl.part &#8212; SKiDL  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <h1 id="site-title"><a href="../../../../"><img src="../../../../images/slim_banner.png" width="100%"></a></h1>
    
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SKiDL  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">skidl.part</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for skidl.part</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># The MIT License (MIT) - Copyright (c) 2016-2021 Dave Vandenbout.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Handles parts.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># isort:skip</span>
    <span class="n">absolute_import</span><span class="p">,</span>
    <span class="n">division</span><span class="p">,</span>
    <span class="n">print_function</span><span class="p">,</span>
    <span class="n">unicode_literals</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">super</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>

<span class="kn">from</span> <span class="nn">future</span> <span class="kn">import</span> <span class="n">standard_library</span>

<span class="kn">from</span> <span class="nn">.common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.erc</span> <span class="kn">import</span> <span class="n">dflt_part_erc</span>
<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">active_logger</span>
<span class="kn">from</span> <span class="nn">.skidlbaseobj</span> <span class="kn">import</span> <span class="n">SkidlBaseObject</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PySpice.Unit.Unit</span> <span class="kn">import</span> <span class="n">UnitValue</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># PySpice is not supported in Python 2, so need to make a dummy class</span>
    <span class="c1"># to replicate a class from PySpice.</span>
    <span class="k">class</span> <span class="nc">UnitValue</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="c1"># Places where parts can be stored.</span>
<span class="c1">#   NETLIST: The part will become part of a circuit netlist.</span>
<span class="c1">#   LIBRARY: The part will be placed in the part list for a library.</span>
<span class="c1">#   TEMPLATE: The part will be used as a template to be copied from.</span>
<span class="n">NETLIST</span><span class="p">,</span> <span class="n">LIBRARY</span><span class="p">,</span> <span class="n">TEMPLATE</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NETLIST&quot;</span><span class="p">,</span> <span class="s2">&quot;LIBRARY&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMPLATE&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="PinNumberSearch"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PinNumberSearch">[docs]</a><span class="k">class</span> <span class="nc">PinNumberSearch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for restricting part pin indexing to only pin numbers</span>
<span class="sd">    while ignoring pin names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="c1"># Store the part this object belongs to.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="n">part</span>

<div class="viewcode-block" id="PinNumberSearch.get_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PinNumberSearch.get_pins">[docs]</a>    <span class="k">def</span> <span class="nf">get_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="c1"># Add criteria that restricts pin searching to only numbers.</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;only_search_numbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Now search the part for pin numbers matching the pin_ids.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">get_pins</span><span class="p">(</span><span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span></div>

    <span class="c1"># Get pin numbers from a part using brackets, e.g. [1,5:9].</span>
    <span class="fm">__getitem__</span> <span class="o">=</span> <span class="n">get_pins</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">pins_nets_buses</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">pins_nets_buses</span><span class="p">)</span></div>


<div class="viewcode-block" id="PinNameSearch"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PinNameSearch">[docs]</a><span class="k">class</span> <span class="nc">PinNameSearch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for restricting part pin indexing to only pin names</span>
<span class="sd">    while ignoring pin numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="n">part</span>

<div class="viewcode-block" id="PinNameSearch.get_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PinNameSearch.get_pins">[docs]</a>    <span class="k">def</span> <span class="nf">get_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="c1"># Add criteria that restricts pin searching to only names.</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;only_search_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Now search the part for pin names matching the pin_ids.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">get_pins</span><span class="p">(</span><span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span></div>

    <span class="c1"># Get pin names from a part using brackets, e.g. [&#39;A1, A2, A3&#39;].</span>
    <span class="fm">__getitem__</span> <span class="o">=</span> <span class="n">get_pins</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">pins_nets_buses</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="o">*</span><span class="n">pins_nets_buses</span><span class="p">)</span></div>


<div class="viewcode-block" id="Part"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part">[docs]</a><span class="k">class</span> <span class="nc">Part</span><span class="p">(</span><span class="n">SkidlBaseObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for storing a definition of a schematic part.</span>

<span class="sd">    Args:</span>
<span class="sd">        lib: Either a SchLib object or a schematic part library file name.</span>
<span class="sd">        name: A string with name of the part to find in the library, or to assign to</span>
<span class="sd">            the part defined by the part definition.</span>
<span class="sd">        dest: String that indicates where the part is destined for (e.g., LIBRARY).</span>
<span class="sd">        tool: The format for the library file or part definition (e.g., KICAD).</span>
<span class="sd">        connections: A dictionary with part pin names/numbers as keys and the</span>
<span class="sd">            nets to which they will be connected as values. For example:</span>
<span class="sd">            { &#39;IN-&#39;:a_in, &#39;IN+&#39;:gnd, &#39;1&#39;:AMPED_OUTPUT, &#39;14&#39;:vcc, &#39;7&#39;:gnd }</span>
<span class="sd">        part_defn: A list of strings that define the part (usually read from a</span>
<span class="sd">            schematic library file).</span>
<span class="sd">        circuit: The Circuit object this Part belongs to.</span>
<span class="sd">        ref_prefix: Prefix for part references such as &#39;U&#39; or &#39;J&#39;.</span>
<span class="sd">        ref: A specific part reference to be assigned.</span>
<span class="sd">        tag: A specific tag to tie the part to its footprint in the PCB.</span>
<span class="sd">        pin_splitters: String of characters that split long pin names into shorter aliases.</span>
<span class="sd">        tool_version: Select between KiCad V5 and V6.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        kwargs: Name/value pairs for setting attributes for the part.</span>
<span class="sd">            For example, manf_num=&#39;LM4808MP-8&#39; would create an attribute</span>
<span class="sd">            named &#39;manf_num&#39; for the part and assign it the value &#39;LM4808MP-8&#39;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        * Exception if the part library and definition are both missing.</span>
<span class="sd">        * Exception if an unknown file format is requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set the default ERC functions for all Part instances.</span>
    <span class="n">erc_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dflt_part_erc</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="n">NETLIST</span><span class="p">,</span>
        <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">connections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">part_defn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">circuit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_prefix</span><span class="o">=</span><span class="s2">&quot;U&quot;</span><span class="p">,</span>
        <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pin_splitters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tool_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="kn">import</span> <span class="nn">skidl</span>

        <span class="kn">from</span> <span class="nn">.schlib</span> <span class="kn">import</span> <span class="n">SchLib</span>
        <span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">SKIDL</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">get_default_tool</span><span class="p">()</span>

        <span class="c1"># Setup some part attributes that might be overwritten later on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_erc</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Allow part to be included in ERC.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary for storing subunits of the part, if desired.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Start with no pins, but a place to store them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">PinNumberSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Does pin search using only pin numbers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">PinNameSearch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Does pin search using only pin names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>  <span class="c1"># Assign initial part name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Make sure there is a description, even if empty.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Provide a member for holding a reference.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_prefix</span> <span class="o">=</span> <span class="n">ref_prefix</span>  <span class="c1"># Store the part reference prefix.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool</span> <span class="o">=</span> <span class="n">tool</span>  <span class="c1"># Initial type of part (SKIDL, KICAD, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Part starts off unassociated with any circuit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_pin_regex</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Don&#39;t allow regex matches of pin names.</span>

        <span class="c1"># Create a Part from a library entry.</span>
        <span class="k">if</span> <span class="n">lib</span><span class="p">:</span>
            <span class="c1"># If the lib argument is a string, then create a library using the</span>
            <span class="c1"># string as the library file name.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">libname</span> <span class="o">=</span> <span class="n">lib</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lib</span> <span class="o">=</span> <span class="n">SchLib</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">libname</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="n">tool</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">skidl</span><span class="o">.</span><span class="n">QUERY_BACKUP_LIB</span><span class="p">:</span>
                        <span class="n">active_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Could not load KiCad schematic library &quot;</span><span class="si">{}</span><span class="s1">&quot;, falling back to backup library.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">libname</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">lib</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">load_backup_lib</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">lib</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>

            <span class="c1"># Make a copy of the part from the library but don&#39;t add it to the netlist.</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">lib</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">)</span>

            <span class="c1"># Overwrite self with the new part.</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

            <span class="c1"># Make sure all the pins have a valid reference to this part.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">associate_pins</span><span class="p">()</span>

            <span class="c1"># Copy part units so all the pin and part references stay valid.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_units</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="c1"># Otherwise, create a Part from a part definition. If the part is</span>
        <span class="c1"># destined for a library, then just get its name. If it&#39;s going into</span>
        <span class="c1"># a netlist, then parse the entire part definition.</span>
        <span class="k">elif</span> <span class="n">part_defn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">part_defn</span> <span class="o">=</span> <span class="n">part_defn</span>

            <span class="c1"># If given, set the tool version before parsing the part definition.</span>
            <span class="c1"># At this time, this is done to support differences between KiCad V5 and V6.</span>
            <span class="k">if</span> <span class="n">tool_version</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tool_version</span> <span class="o">=</span> <span class="n">tool_version</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">get_name_only</span><span class="o">=</span><span class="p">(</span><span class="n">dest</span> <span class="o">!=</span> <span class="n">NETLIST</span><span class="p">))</span>

        <span class="c1"># If the part is destined for a SKiDL library, then it will be defined</span>
        <span class="c1"># by the additional attribute values that are passed.</span>
        <span class="k">elif</span> <span class="n">tool</span> <span class="o">==</span> <span class="n">SKIDL</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t make a part without a library &amp; part name or a part definition.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Split multi-part pin names into individual pin aliases.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_pin_names</span><span class="p">(</span><span class="n">pin_splitters</span><span class="p">)</span>

        <span class="c1"># Setup the tag for tieing the part to a footprint in a pcb editor.</span>
        <span class="c1"># Do this before adding the part to the circuit or an exception will occur</span>
        <span class="c1"># because the part can&#39;t give its hierarchical name to the circuit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">dest</span> <span class="o">!=</span> <span class="n">LIBRARY</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="n">NETLIST</span><span class="p">:</span>
                <span class="c1"># If the part is going to be an element in a circuit, then add it to the</span>
                <span class="c1"># the circuit and make any indicated pin/net connections.</span>
                <span class="c1"># If no Circuit object is given, then use the default Circuit that always exists.</span>
                <span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit</span> <span class="ow">or</span> <span class="n">default_circuit</span>
                <span class="n">circuit</span> <span class="o">+=</span> <span class="bp">self</span>
            <span class="k">elif</span> <span class="n">dest</span> <span class="o">==</span> <span class="n">TEMPLATE</span><span class="p">:</span>
                <span class="c1"># If this is just a part template, don&#39;t add the part to the circuit.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Add any net/pin connections to this part that were passed as arguments.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connections</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pin</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">connections</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">net</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span>

        <span class="c1"># Add any XSPICE I/O as pins. (This only happens with SPICE simulations.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_xspice_io</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;io&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># Set the part reference if one was explicitly provided.</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>

        <span class="c1"># Add any other passed-in attributes to the part.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># If any pins were added, make sure they&#39;re associated with the part.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associate_pins</span><span class="p">()</span>

<div class="viewcode-block" id="Part.add_xspice_io"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.add_xspice_io">[docs]</a>    <span class="k">def</span> <span class="nf">add_xspice_io</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add XSPICE I/O to the pins of a part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.pin</span> <span class="kn">import</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">PinList</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">io</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Change a string into a list with a single string element.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">io</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="p">]</span>

        <span class="c1"># Join all the pin name arguments into a comma-separated string and then split them into a list.</span>
        <span class="n">ios</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">INDEX_SEPARATOR</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">io</span><span class="p">))</span>

        <span class="c1"># Add a pin to the part for each pin name.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ios</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Strip any spaces that may have been between pin names.</span>

            <span class="c1"># If [pin_name] or pin_name[], then add a PinList to the part. Don&#39;t use</span>
            <span class="c1"># part.add_pins() because it will flatten the PinList and add nothing since</span>
            <span class="c1"># the PinList is empty.</span>
            <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;[]&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PinList</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">part</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;[]&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PinList</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">part</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add a simple, non-vector pin.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_pins</span><span class="p">(</span><span class="n">Pin</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">arg</span><span class="p">))</span></div>

<div class="viewcode-block" id="Part.get"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.get">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">circuit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the part with the given text from a circuit, or return None.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: A text string that will be searched for in the list of</span>
<span class="sd">                parts.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            circuit: The circuit whose parts will be searched. If set to None,</span>
<span class="sd">                then the parts in the default_circuit will be searched.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of parts or a single part that match the text string with</span>
<span class="sd">            either their reference, name, alias, or their description.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">circuit</span><span class="p">:</span>
            <span class="n">circuit</span> <span class="o">=</span> <span class="n">default_circuit</span>

        <span class="n">search_params</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">do_str_match</span> <span class="ow">in</span> <span class="n">search_params</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">filter_list</span><span class="p">(</span><span class="n">circuit</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="n">do_str_match</span><span class="o">=</span><span class="n">do_str_match</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">list_or_scalar</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_find_min_max_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the minimum and maximum pin numbers for the part.&quot;&quot;&quot;</span>
        <span class="n">pin_nums</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pin_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">num</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># This happens if the part has no pins.</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">pin_nums</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pin_nums</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># This happens if the part has no integer-labeled pins.</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

<div class="viewcode-block" id="Part.parse"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_name_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a part from its stored part definition.</span>

<span class="sd">        Args:</span>
<span class="sd">            get_name_only: When true, just get the name and aliases for the</span>
<span class="sd">                part. Leave the rest unparsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get the function to parse the part description.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parse_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_parse_lib_part_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t create a part with an unknown ECAD tool file format: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tool</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Parse the part description.</span>
        <span class="n">parse_func</span><span class="p">(</span><span class="n">get_name_only</span><span class="p">)</span></div>

<div class="viewcode-block" id="Part.associate_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.associate_pins">[docs]</a>    <span class="k">def</span> <span class="nf">associate_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure all the pins in a part have valid references to the part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Part.copy"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_copies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">NETLIST</span><span class="p">,</span> <span class="n">circuit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attribs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make zero or more copies of this part while maintaining all pin/net</span>
<span class="sd">        connections.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_copies: Number of copies to make of this part.</span>
<span class="sd">            dest: Indicates where the copy is destined for (e.g., NETLIST).</span>
<span class="sd">            circuit: The circuit this part should be added to.</span>
<span class="sd">            io: XSPICE I/O names.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            attribs: Name/value pairs for setting attributes for the copy.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of Part copies or a single Part if num_copies==1.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception if the requested number of copies is a non-integer or negative.</span>

<span class="sd">        Notes:</span>
<span class="sd">            An instance of a part can be copied just by calling it like so::</span>

<span class="sd">                res = Part(&quot;Device&quot;,&#39;R&#39;)    # Get a resistor.</span>
<span class="sd">                res_copy = res(value=&#39;1K&#39;)  # Copy the resistor and set resistance value.</span>

<span class="sd">            You can also use the multiplication operator to make copies::</span>

<span class="sd">                cap = Part(&quot;Device&quot;, &#39;C&#39;)   # Get a capacitor</span>
<span class="sd">                caps = 10 * cap             # Make an array with 10 copies of it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.circuit</span> <span class="kn">import</span> <span class="n">Circuit</span>
        <span class="kn">from</span> <span class="nn">.part</span> <span class="kn">import</span> <span class="n">NETLIST</span>
        <span class="kn">from</span> <span class="nn">.pin</span> <span class="kn">import</span> <span class="n">Pin</span>

        <span class="c1"># If the number of copies is None, then a single copy will be made</span>
        <span class="c1"># and returned as a scalar (not a list). Otherwise, the number of</span>
        <span class="c1"># copies will be set by the num_copies parameter or the number of</span>
        <span class="c1"># values supplied for each part attribute.</span>
        <span class="n">num_copies_attribs</span> <span class="o">=</span> <span class="n">find_num_copies</span><span class="p">(</span><span class="o">**</span><span class="n">attribs</span><span class="p">)</span>
        <span class="n">return_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_copies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_copies_attribs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_copies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_copies</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_copies_attribs</span><span class="p">)</span>

        <span class="c1"># Check that a valid number of copies is requested.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_copies</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t make a non-integer number (</span><span class="si">{}</span><span class="s2">) of copies of a part!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">num_copies</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">num_copies</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t make a negative number (</span><span class="si">{}</span><span class="s2">) of copies of a part!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">num_copies</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Now make copies of the part one-by-one.</span>
        <span class="n">copies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_copies</span><span class="p">):</span>

            <span class="c1"># Make a shallow copy of the part.</span>
            <span class="n">cpy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Remove any existing Pin and PartUnit attributes so new ones</span>
            <span class="c1"># can be made in the copy without generating warning messages.</span>
            <span class="n">rmv_attrs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">k</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cpy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">Pin</span><span class="p">,</span> <span class="n">PartUnit</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">rmv_attrs</span><span class="p">:</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">cpy</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="c1"># The shallow copy will just put references to the pins of the</span>
            <span class="c1"># original into the copy, so create independent copies of the pins.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cpy</span> <span class="o">+=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">]</span>  <span class="c1"># Add pin and its attribute.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">pin_aliases_to_attributes</span><span class="p">()</span>  <span class="c1"># Add pin aliases as part attributes.</span>

            <span class="c1"># If the part copy is intended as a template, then disconnect its pins</span>
            <span class="c1"># from any circuit nets.</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="n">TEMPLATE</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cpy</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

            <span class="c1"># Make sure all the pins have a reference to this new part copy.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">associate_pins</span><span class="p">()</span>

            <span class="c1"># Make new objects for searching the copy&#39;s pin numbers and names.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">PinNumberSearch</span><span class="p">(</span><span class="n">cpy</span><span class="p">)</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">PinNameSearch</span><span class="p">(</span><span class="n">cpy</span><span class="p">)</span>

            <span class="c1"># Copy the part fields from the original.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="c1"># Copy part units from the original to the copy.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">copy_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Clear the part reference of the copied part so a unique reference</span>
            <span class="c1"># can be assigned when the part is added to the circuit.</span>
            <span class="c1"># (This is not strictly necessary since the part reference will be</span>
            <span class="c1"># adjusted to be unique if needed during the addition process.)</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Copied part starts off not being in any circuit.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">circuit</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Reset the tag to a random generated one.  We</span>
            <span class="c1"># are careful to do this after setting the circuit to</span>
            <span class="c1"># None so we don&#39;t corrupt the hierarchical name index</span>
            <span class="c1"># maintained in circuit.</span>
            <span class="k">del</span> <span class="n">cpy</span><span class="o">.</span><span class="n">tag</span>

            <span class="c1"># If copy is destined for a netlist, then add it to the Circuit its</span>
            <span class="c1"># source came from or else add it to the default Circuit object.</span>
            <span class="k">if</span> <span class="n">dest</span> <span class="o">==</span> <span class="n">NETLIST</span><span class="p">:</span>
                <span class="c1"># Place the copied part in the explicitly-stated circuit,</span>
                <span class="c1"># or the same circuit as the original,</span>
                <span class="c1"># or else into the default circuit.</span>
                <span class="n">circuit</span> <span class="o">=</span> <span class="n">circuit</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="ow">or</span> <span class="n">default_circuit</span>
                <span class="n">circuit</span> <span class="o">+=</span> <span class="n">cpy</span>

            <span class="c1"># Add any XSPICE I/O as pins to the part.</span>
            <span class="n">cpy</span><span class="o">.</span><span class="n">add_xspice_io</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

            <span class="c1"># Enter any new attributes.</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                            <span class="ne">ValueError</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> copies of part </span><span class="si">{}</span><span class="s2"> were requested, but too few elements in attribute </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">num_copies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">k</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cpy</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

            <span class="c1"># Add the part copy to the list of copies.</span>
            <span class="n">copies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpy</span><span class="p">)</span>

        <span class="c1"># Return a list of the copies made or just a single copy.</span>
        <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copies</span>
        <span class="k">return</span> <span class="n">copies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Part.validate"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that pins and units reference the correct part that owns them.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">pin</span><span class="o">.</span><span class="n">part</span> <span class="o">==</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">unit</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span></div>

    <span class="c1"># Make copies with the multiplication operator or by calling the object.</span>
    <span class="fm">__call__</span> <span class="o">=</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_copies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num_copies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_copies</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">num_copies</span><span class="o">=</span><span class="n">num_copies</span><span class="p">)</span>

    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="fm">__mul__</span>

<div class="viewcode-block" id="Part.copy_units"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.copy_units">[docs]</a>    <span class="k">def</span> <span class="nf">copy_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make copies of the units from the source part.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Remove references to any existing units.</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get the pin numbers from the unit in the source part.</span>
            <span class="n">pin_nums</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">unit</span><span class="o">.</span><span class="n">pins</span><span class="p">]</span>

            <span class="c1"># Make a unit in the part copy with the same pin numbers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_unit</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_nums</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">num</span></div>

<div class="viewcode-block" id="Part.add_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.add_pins">[docs]</a>    <span class="k">def</span> <span class="nf">add_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one or more pins to a part.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">pins</span><span class="p">):</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="c1"># Create attributes so pin can be accessed by name or number such</span>
            <span class="c1"># as part.ENBL or part.p5.</span>
            <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
            <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">num</span><span class="p">),</span> <span class="n">pin</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="fm">__iadd__</span> <span class="o">=</span> <span class="n">add_pins</span>

<div class="viewcode-block" id="Part.rmv_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.rmv_pins">[docs]</a>    <span class="k">def</span> <span class="nf">rmv_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove one or more pins from a part.&quot;&quot;&quot;</span>
        <span class="n">pins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pin</span><span class="o">.</span><span class="n">num</span> <span class="ow">in</span> <span class="n">pin_ids</span> <span class="ow">or</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">pin_ids</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">pins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="Part.swap_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.swap_pins">[docs]</a>    <span class="k">def</span> <span class="nf">swap_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_id1</span><span class="p">,</span> <span class="n">pin_id2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Swap pin name/number between two pins of a part.&quot;&quot;&quot;</span>
        <span class="n">pins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span>
        <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pins</span><span class="p">):</span>
            <span class="n">pin_num_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin_id1</span> <span class="ow">in</span> <span class="n">pin_num_name</span><span class="p">:</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">pin_id2</span> <span class="ow">in</span> <span class="n">pin_num_name</span><span class="p">:</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">i1</span> <span class="ow">and</span> <span class="n">i2</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">i1</span> <span class="ow">and</span> <span class="n">i2</span><span class="p">:</span>
            <span class="n">pins</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">pins</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pins</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">pins</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pins</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>
                <span class="n">pins</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">pins</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">num</span><span class="p">,</span>
                <span class="n">pins</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Part.rename_pin"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.rename_pin">[docs]</a>    <span class="k">def</span> <span class="nf">rename_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_id</span><span class="p">,</span> <span class="n">new_pin_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign a new name to a pin of a part.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin_id</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">pin</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_pin_name</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="Part.renumber_pin"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.renumber_pin">[docs]</a>    <span class="k">def</span> <span class="nf">renumber_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_id</span><span class="p">,</span> <span class="n">new_pin_num</span><span class="p">):</span>
        <span class="s2">&quot;Assign a new number to a pin of a part.&quot;</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin_id</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">pin</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">new_pin_num</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="Part.get_pins"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.get_pins">[docs]</a>    <span class="k">def</span> <span class="nf">get_pins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of part pins selected by pin numbers or names.</span>

<span class="sd">        Args:</span>
<span class="sd">            pin_ids: A list of strings containing pin names, numbers,</span>
<span class="sd">                regular expressions, slices, lists or tuples. If empty,</span>
<span class="sd">                then it will select all pins.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            criteria: Key/value pairs that specify attribute values the</span>
<span class="sd">                pins must have in order to be selected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of pins matching the given IDs and satisfying all the criteria,</span>
<span class="sd">            or just a single Pin object if only a single match was found.</span>
<span class="sd">            Or None if no match was found.</span>

<span class="sd">        Notes:</span>
<span class="sd">            Pins can be selected from a part by using brackets like so::</span>

<span class="sd">                atmega = Part(&#39;atmel&#39;, &#39;ATMEGA16U2&#39;)</span>
<span class="sd">                net = Net()</span>
<span class="sd">                atmega[1] += net  # Connects pin 1 of chip to the net.</span>
<span class="sd">                net += atmega[&#39;RESET&#39;]  # Connects reset pin to the net.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.alias</span> <span class="kn">import</span> <span class="n">Alias</span>
        <span class="kn">from</span> <span class="nn">.netpinlist</span> <span class="kn">import</span> <span class="n">NetPinList</span>

        <span class="c1"># Extract restrictions on searching for only pin names or numbers.</span>
        <span class="n">only_search_numbers</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;only_search_numbers&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">only_search_names</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;only_search_names&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Extract permission to search for regex matches in pin names/aliases.</span>
        <span class="n">match_regex</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;match_regex&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_pin_regex</span>

        <span class="c1"># If no pin identifiers were given, then use a wildcard that will</span>
        <span class="c1"># select all pins.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pin_ids</span><span class="p">:</span>
            <span class="n">pin_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.*&quot;</span><span class="p">]</span>
            <span class="n">match_regex</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Determine the minimum and maximum pin ids if they don&#39;t already exist.</span>
        <span class="k">if</span> <span class="s2">&quot;min_pin&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;max_pin&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_pin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_min_max_pins</span><span class="p">()</span>

        <span class="c1"># Go through the list of pin IDs one-by-one.</span>
        <span class="n">pins</span> <span class="o">=</span> <span class="n">NetPinList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="n">expand_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_pin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_pin</span><span class="p">,</span> <span class="n">match_regex</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">):</span>

            <span class="c1"># If only names are being searched, the search of pin numbers is skipped.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">only_search_names</span><span class="p">:</span>
                <span class="c1"># Does pin ID (either integer or string) match a pin number...</span>
                <span class="n">tmp_pins</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">),</span> <span class="n">do_str_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_pins</span><span class="p">:</span>
                    <span class="n">pins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_pins</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="c1"># if only numbers are being searched, then search of pin names is skipped.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">only_search_numbers</span><span class="p">:</span>
                <span class="c1"># OK, assume it&#39;s not a pin number but a pin name or alias.</span>
                <span class="c1"># Look for an exact match.</span>

                <span class="c1"># Check pin aliases for an exact match.</span>
                <span class="n">tmp_pins</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">p_id</span><span class="p">,</span> <span class="n">do_str_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_pins</span><span class="p">:</span>
                    <span class="n">pins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_pins</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Check pin names for an exact match.</span>
                <span class="n">tmp_pins</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">p_id</span><span class="p">,</span> <span class="n">do_str_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_pins</span><span class="p">:</span>
                    <span class="n">pins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_pins</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Skip regex matching if not enabled.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match_regex</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># OK, pin ID is not a pin number and doesn&#39;t exactly match a pin</span>
                <span class="c1"># name or alias. Does it match as a regex?</span>
                <span class="n">p_id_re</span> <span class="o">=</span> <span class="n">p_id</span>

                <span class="c1"># Check pin aliases for a regex match.</span>
                <span class="n">tmp_pins</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="n">Alias</span><span class="p">(</span><span class="n">p_id_re</span><span class="p">),</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_pins</span><span class="p">:</span>
                    <span class="n">pins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_pins</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Check the pin names for a regex match.</span>
                <span class="n">tmp_pins</span> <span class="o">=</span> <span class="n">filter_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">p_id_re</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp_pins</span><span class="p">:</span>
                    <span class="n">pins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_pins</span><span class="p">)</span>
                    <span class="k">continue</span>

        <span class="k">return</span> <span class="n">list_or_scalar</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span></div>

    <span class="c1"># Get pins from a part using brackets, e.g. [1,5:9,&#39;A[0-9]+&#39;].</span>
    <span class="fm">__getitem__</span> <span class="o">=</span> <span class="n">get_pins</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">pins_nets_buses</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        You can&#39;t assign to the pins of parts. You must use the += operator.</span>

<span class="sd">        This method is a work-around that allows the use of the += for making</span>
<span class="sd">        connections to pins while prohibiting direct assignment. Python</span>
<span class="sd">        processes something like my_part[&#39;GND&#39;] += gnd as follows::</span>

<span class="sd">            1. Part.__getitem__ is called with &#39;GND&#39; as the index. This</span>
<span class="sd">               returns a single Pin or a NetPinList.</span>
<span class="sd">            2. The Pin.__iadd__ or NetPinList.__iadd__ method is passed</span>
<span class="sd">               the thing to connect to the pin (gnd in this case). This method</span>
<span class="sd">               makes the actual connection to the part pin or pins. Then it</span>
<span class="sd">               creates an iadd_flag attribute in the object it returns.</span>
<span class="sd">            3. Finally, Part.__setitem__ is called. If the iadd_flag attribute</span>
<span class="sd">               is true in the passed argument, then __setitem__ was entered</span>
<span class="sd">               as part of processing the += operator. If there is no</span>
<span class="sd">               iadd_flag attribute, then __setitem__ was entered as a result</span>
<span class="sd">               of using a direct assignment, which is not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If the iadd_flag is set, then it&#39;s OK that we got</span>
        <span class="c1"># here and don&#39;t issue an error. Also, delete the flag.</span>
        <span class="k">if</span> <span class="n">from_iadd</span><span class="p">(</span><span class="n">pins_nets_buses</span><span class="p">):</span>
            <span class="n">rmv_iadd</span><span class="p">(</span><span class="n">pins_nets_buses</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># No iadd_flag or it wasn&#39;t set. This means a direct assignment</span>
        <span class="c1"># was made to the pin, which is not allowed.</span>
        <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t assign to a part! Use the += operator.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator for stepping thru individual pins of the part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span>  <span class="c1"># Return generator expr.</span>

<div class="viewcode-block" id="Part.is_connected"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return T/F depending upon whether a part is connected in a netlist.</span>

<span class="sd">        If a part has pins but none of them are connected to nets, then</span>
<span class="sd">        this method will return False. Otherwise, it will return True even if</span>
<span class="sd">        the part has no pins (which can be the case for mechanical parts,</span>
<span class="sd">        silkscreen logos, or other non-electrical schematic elements).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Assume parts without pins (like mech. holes) are always connected.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># If any pin is found to be connected to a net, return True.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># No net connections found, so return False.</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Part.attached_to"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.attached_to">[docs]</a>    <span class="k">def</span> <span class="nf">attached_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if any part pin is connected to a net in the list.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nets</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pins</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">pin</span><span class="o">.</span><span class="n">get_nets</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">nets</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Part.is_movable"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.is_movable">[docs]</a>    <span class="k">def</span> <span class="nf">is_movable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return T/F if the part can be moved from one circuit into another.</span>

<span class="sd">        This method returns true if:</span>
<span class="sd">            1) the part is not in a circuit, or</span>
<span class="sd">            2) the part has pins but none of them are connected to nets, or</span>
<span class="sd">            3) the part has no pins (which can be the case for mechanical parts,</span>
<span class="sd">               silkscreen logos, or other non-electrical schematic elements).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.circuit</span> <span class="kn">import</span> <span class="n">Circuit</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">Circuit</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Part.set_pin_alias"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.set_pin_alias">[docs]</a>    <span class="k">def</span> <span class="nf">set_pin_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the alias for a part pin.</span>

<span class="sd">        Args:</span>
<span class="sd">            alias: The alias for the pin.</span>
<span class="sd">            pin_ids: A list of strings containing pin names, numbers,</span>
<span class="sd">                regular expressions, slices, lists or tuples.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            criteria: Key/value pairs that specify attribute values the</span>
<span class="sd">                pin must have in order to be selected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.alias</span> <span class="kn">import</span> <span class="n">Alias</span>
        <span class="kn">from</span> <span class="nn">.pin</span> <span class="kn">import</span> <span class="n">Pin</span>

        <span class="n">pin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pins</span><span class="p">(</span><span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">Pin</span><span class="p">):</span>
            <span class="c1"># Alias the single pin that was found.</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">aliases</span> <span class="o">+=</span> <span class="n">alias</span>
            <span class="c1"># Add the name of the aliased pin as an attribute to the part,</span>
            <span class="c1"># so it will act just like a pin for making connections.</span>
            <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Error: either 0 or multiple pins were found.</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;Cannot set alias for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pin_ids</span><span class="p">))</span></div>

<div class="viewcode-block" id="Part.pin_aliases_to_attributes"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.pin_aliases_to_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">pin_aliases_to_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make each pin alias into an attribute of the part.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">pin</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></div>

<div class="viewcode-block" id="Part.split_pin_names"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.split_pin_names">[docs]</a>    <span class="k">def</span> <span class="nf">split_pin_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use chars in delimiters to split pin names and add as aliases to each pin.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">delimiters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c1"># Split pin name and add subnames as aliases to the pin.</span>
                <span class="n">pin</span><span class="o">.</span><span class="n">split_name</span><span class="p">(</span><span class="n">delimiters</span><span class="p">)</span>

            <span class="c1"># Add the pin aliases as attributes to the part.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pin_aliases_to_attributes</span><span class="p">()</span></div>

<div class="viewcode-block" id="Part.make_unit"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.make_unit">[docs]</a>    <span class="k">def</span> <span class="nf">make_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a PartUnit from a set of pins in a Part object.</span>

<span class="sd">        Parts can be organized into smaller pieces called PartUnits. A PartUnit</span>
<span class="sd">        acts like a Part but contains only a subset of the pins of the Part.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: The label used to identify the PartUnit.</span>
<span class="sd">            pin_ids: A list of strings containing pin names, numbers,</span>
<span class="sd">                regular expressions, slices, lists or tuples.</span>

<span class="sd">        Keyword Args:</span>
<span class="sd">            criteria: Key/value pairs that specify attribute values the</span>
<span class="sd">                pin must have in order to be selected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The PartUnit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Warn if the unit label collides with any of the part&#39;s pin names.</span>
        <span class="n">collisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pins</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>  <span class="c1"># Look for exact match.</span>
        <span class="k">if</span> <span class="n">collisions</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Using a label (</span><span class="si">{}</span><span class="s2">) for a unit of </span><span class="si">{}</span><span class="s2"> that matches one or more of it&#39;s pin names (</span><span class="si">{}</span><span class="s2">)!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">erc_desc</span><span class="p">(),</span> <span class="n">collisions</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Create the part unit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">PartUnit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span>
        <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">[</span><span class="n">label</span><span class="p">]</span></div>

<div class="viewcode-block" id="Part.create_network"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.create_network">[docs]</a>    <span class="k">def</span> <span class="nf">create_network</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a network from the pins of a part.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="n">Network</span>

        <span class="n">ntwk</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">[:])</span>  <span class="c1"># An error will occur if part has more than 2 pins.</span>
        <span class="k">return</span> <span class="n">ntwk</span></div>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a part and another part/pin/net in serial.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="n">Network</span>

        <span class="k">return</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__rand__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a part and another part/pin/net in serial.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="n">Network</span>

        <span class="k">return</span> <span class="n">obj</span> <span class="o">&amp;</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a part and another part/pin/net in parallel.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="n">Network</span>

        <span class="k">return</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">|</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a part and another part/pin/net in parallel.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.network</span> <span class="kn">import</span> <span class="n">Network</span>

        <span class="k">return</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of component field names.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.pin</span> <span class="kn">import</span> <span class="n">Pin</span>

        <span class="c1"># Get all the component attributes and subtract all the ones that</span>
        <span class="c1"># should not appear under &quot;fields&quot; in the netlist or XML.</span>
        <span class="c1"># Also, skip all the Pin and PartUnit attributes.</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">k</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">Pin</span><span class="p">,</span> <span class="n">PartUnit</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">non_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;min_pin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max_pin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hierarchy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_tag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_ref&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_prefix&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;num_units&quot;</span><span class="p">,</span>
                <span class="s2">&quot;part_defn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;definition&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">,</span>
                <span class="s2">&quot;draw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lib&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fplist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;do_erc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aliases&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pins&quot;</span><span class="p">,</span>
                <span class="s2">&quot;footprint&quot;</span><span class="p">,</span>
                <span class="s2">&quot;circuit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skidl_trace&quot;</span><span class="p">,</span>
                <span class="s2">&quot;search_text&quot;</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
                <span class="s2">&quot;p&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">fields</span> <span class="o">-</span> <span class="n">non_fields</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_value_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return value of part as a string.&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_prefix</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Part.generate_netlist_component"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.generate_netlist_component">[docs]</a>    <span class="k">def</span> <span class="nf">generate_netlist_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the part information for inclusion in a netlist.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool: The format for the netlist file (e.g., KICAD).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">skidl</span>

        <span class="k">if</span> <span class="n">tool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">get_default_tool</span><span class="p">()</span>

        <span class="c1"># Create part value as a string so including it in netlist isn&#39;t a problem.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_to_str</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gen_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gen_netlist_comp_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t generate netlist in an unknown ECAD tool format (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tool</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gen_func</span><span class="p">()</span></div>

<div class="viewcode-block" id="Part.generate_xml_component"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.generate_xml_component">[docs]</a>    <span class="k">def</span> <span class="nf">generate_xml_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the part information for inclusion in an XML file.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool: The format for the XML file (e.g., KICAD).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">skidl</span>

        <span class="k">if</span> <span class="n">tool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">get_default_tool</span><span class="p">()</span>

        <span class="c1"># Create part value as a string so including it in XML isn&#39;t a problem.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_to_str</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gen_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gen_xml_comp_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t generate XML in an unknown ECAD tool format (</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gen_func</span><span class="p">()</span></div>

<div class="viewcode-block" id="Part.generate_svg_component"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.generate_svg_component">[docs]</a>    <span class="k">def</span> <span class="nf">generate_svg_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symtx</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">net_stubs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the SVG for displaying a part in an SVG schematic.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">skidl</span>

        <span class="k">if</span> <span class="n">tool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">get_default_tool</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gen_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gen_svg_comp_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t generate SVG for a component in an unknown ECAD tool format(</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tool</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gen_func</span><span class="p">(</span><span class="n">symtx</span><span class="o">=</span><span class="n">symtx</span><span class="p">,</span> <span class="n">net_stubs</span><span class="o">=</span><span class="n">net_stubs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Part.generate_pinboxes"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.generate_pinboxes">[docs]</a>    <span class="k">def</span> <span class="nf">generate_pinboxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the pinboxes for arranging parts in a schematic.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">skidl</span>

        <span class="k">if</span> <span class="n">tool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">skidl</span><span class="o">.</span><span class="n">get_default_tool</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gen_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gen_pinboxes_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t generate pinboxes for a component in an unknown ECAD tool format(</span><span class="si">{}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tool</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gen_func</span><span class="p">()</span></div>

<div class="viewcode-block" id="Part.erc_desc"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.erc_desc">[docs]</a>    <span class="k">def</span> <span class="nf">erc_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create description of part for ERC and other error reporting.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{p.name}</span><span class="s2">/</span><span class="si">{p.ref}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a description of the pins on this part as a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{name}</span><span class="s2"> (</span><span class="si">{aliases}</span><span class="s2">): </span><span class="si">{desc}</span><span class="se">\n</span><span class="s2">    </span><span class="si">{pins}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">aliases</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;aliases&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">pins</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

<div class="viewcode-block" id="Part.export"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.Part.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string to recreate a Part object.&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fields</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;ref_prefix&quot;</span><span class="p">,</span>
                <span class="s2">&quot;num_units&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fplist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;do_erc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aliases&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;footprint&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">attribs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">attribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">attribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;dest&#39;:TEMPLATE&quot;</span><span class="p">)</span>
        <span class="n">attribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;tool&#39;:SKIDL&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">attribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="n">pin_strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">export</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">]</span>
            <span class="n">attribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;pins&#39;:[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pin_strs</span><span class="p">)))</span>

        <span class="c1"># Return the string after removing all the non-ascii stuff (like ohm symbols).</span>
        <span class="k">return</span> <span class="s2">&quot;Part(**{{ </span><span class="si">{}</span><span class="s2"> }})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attribs</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hierarchical_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hierarchy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the part&#39;s tag.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span>

    <span class="nd">@tag</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the part&#39;s tag.&quot;&quot;&quot;</span>
        <span class="c1"># Remove the part&#39;s old hierarchical name from the index.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">rmv_hierarchical_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_name</span><span class="p">)</span>

        <span class="c1"># Update the part&#39;s tag.</span>
        <span class="n">str_tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9\-_]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">str_tag</span><span class="p">):</span>
            <span class="n">active_logger</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
                <span class="ne">ValueError</span><span class="p">,</span>
                <span class="s2">&quot;Can&#39;t set part tag to </span><span class="si">{}</span><span class="s2"> it contains disallowed characters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">str_tag</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="o">=</span> <span class="n">str_tag</span>

        <span class="c1"># Add the udpated hierarchical name back to the index.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">add_hierarchical_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_name</span><span class="p">)</span>

    <span class="nd">@tag</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the part tag.&quot;&quot;&quot;</span>
        <span class="c1"># Part&#39;s can&#39;t have a None tag, so set a new random tag.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get, set and delete the part reference.</span>

<span class="sd">        When setting the part reference, if another part with the same</span>
<span class="sd">        reference is found, the reference for this part is adjusted to make</span>
<span class="sd">        it unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span>

    <span class="nd">@ref</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="c1"># Remove the existing reference so it doesn&#39;t cause a collision if the</span>
        <span class="c1"># object is renamed with its existing name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Now name the object with the given reference or some variation</span>
        <span class="c1"># of it that doesn&#39;t collide with anything else in the list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="n">get_unique_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">parts</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_prefix</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nd">@ref</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the part reference.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get, set and delete the part value.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="n">UnitValue</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># If part has no value, return its part name as the value. This is</span>
            <span class="c1"># done in KiCad where a resistor value is set to &#39;R&#39; if no</span>
            <span class="c1"># explicit value was set.</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the part value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the part value.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">foot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get, set and delete the part footprint.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foot</span>

    <span class="nd">@foot</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">foot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">footprint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the part footprint.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_foot</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">footprint</span><span class="p">)</span>

    <span class="nd">@foot</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">foot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the part footprint.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_foot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">match_pin_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get, set and delete the enable/disable of pin regular-expression matching.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_pin_regex</span>

    <span class="nd">@match_pin_regex</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">match_pin_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the regex matching flag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_match_pin_regex</span> <span class="o">=</span> <span class="n">flag</span>

        <span class="c1"># Also set flag for units of the part.</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">unit</span><span class="o">.</span><span class="n">_match_pin_regex</span> <span class="o">=</span> <span class="n">flag</span>

    <span class="nd">@match_pin_regex</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">match_pin_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete the regex matching flag.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_pin_regex</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any valid Part is True&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>  <span class="c1"># Python 2 compatibility.</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of pins in this part.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span></div>


<span class="c1">##############################################################################</span>

<span class="sd">&quot;&quot;&quot;Shortcut for creating a Part template.&quot;&quot;&quot;</span>
<span class="n">PartTmplt</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">Part</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">)</span>

<span class="c1">##############################################################################</span>


<div class="viewcode-block" id="SkidlPart"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.SkidlPart">[docs]</a><span class="k">class</span> <span class="nc">SkidlPart</span><span class="p">(</span><span class="n">Part</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for storing a SKiDL definition of a schematic part. It&#39;s identical</span>
<span class="sd">    to its Part superclass except:</span>

<span class="sd">    + The tool defaults to SKIDL.</span>
<span class="sd">    + The destination defaults to TEMPLATE so that it&#39;s easier to start</span>
<span class="sd">        a part and then add pins to it without it being added to the netlist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">TEMPLATE</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attribs</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">SKIDL</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tool</span><span class="p">:</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">SKIDL</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">connections</span><span class="p">,</span> <span class="n">attribs</span><span class="p">)</span></div>


<span class="c1">##############################################################################</span>


<div class="viewcode-block" id="PartUnit"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PartUnit">[docs]</a><span class="k">class</span> <span class="nc">PartUnit</span><span class="p">(</span><span class="n">Part</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PartUnit from a set of pins in a Part object.</span>

<span class="sd">    Parts can be organized into smaller pieces called PartUnits. A PartUnit</span>
<span class="sd">    acts like a Part but contains only a subset of the pins of the Part.</span>

<span class="sd">    Args:</span>
<span class="sd">        part: This is the parent Part whose pins the PartUnit is built from.</span>
<span class="sd">        pin_ids: A list of strings containing pin names, numbers,</span>
<span class="sd">            regular expressions, slices, lists or tuples. If empty, it</span>
<span class="sd">            will match *every* pin of the part.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        criteria: Key/value pairs that specify attribute values the</span>
<span class="sd">            pin must have in order to be selected.</span>

<span class="sd">    Examples:</span>
<span class="sd">        This will return unit 1 from a part::</span>

<span class="sd">            lm358 = Part(&#39;linear&#39;,&#39;lm358&#39;)</span>
<span class="sd">            lm358a = PartUnit(lm358, unit=1)</span>

<span class="sd">        Or you can specify the pins directly::</span>

<span class="sd">            lm358a = PartUnit(lm358, 1, 2, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>

        <span class="c1"># Don&#39;t use super() for this.</span>
        <span class="n">SkidlBaseObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Remember the part that this unit belongs to.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1"># Store the part unit label.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="c1"># Store the part unit number if it&#39;s given.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Give the PartUnit the same information as the Part it is generated</span>
        <span class="c1"># from so it can act the same way, just with fewer pins.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Don&#39;t associate any units from the parent with this unit itself.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Remove the pins copied from the parent and replace them with</span>
        <span class="c1"># pins selected from the parent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pins_from_parent</span><span class="p">(</span><span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">)</span>

<div class="viewcode-block" id="PartUnit.add_pins_from_parent"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PartUnit.add_pins_from_parent">[docs]</a>    <span class="k">def</span> <span class="nf">add_pins_from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add selected pins from the parent to the part unit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get new pins selected from the parent.</span>
        <span class="n">new_pins</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_pins</span><span class="p">(</span><span class="o">*</span><span class="n">pin_ids</span><span class="p">,</span> <span class="o">**</span><span class="n">criteria</span><span class="p">))</span>

        <span class="c1"># Remove None if that&#39;s gotten into the list.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_pins</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Add attributes for accessing the new pins.</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">new_pins</span><span class="p">:</span>
            <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">num</span><span class="p">),</span> <span class="n">pin</span><span class="p">)</span>
            <span class="n">add_unique_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="c1"># Add new pins to existing pins of the unit, removing duplicates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">+</span> <span class="n">new_pins</span><span class="p">))</span></div>

<div class="viewcode-block" id="PartUnit.validate"><a class="viewcode-back" href="../../rst_output/skidl.part.html#skidl.part.PartUnit.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that unit pins point to the parent part.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">part</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">))</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SKiDL  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">skidl.part</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2021, Dave Vandenbout.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.2.
    </div>
  </body>
</html>